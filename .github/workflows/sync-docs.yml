name: Documentation Sync

on:
  pull_request:
    types: [opened, synchronize, edited]

jobs:
  sync-docs:
    runs-on: ubuntu-latest
    if: |
      !startsWith(github.event.pull_request.title, 'Version Packages') &&
      github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    steps:
      - name: Generate GitHub App token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: cloudflare

      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD | tr '\n' ',' | sed 's/,$//')
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"

      - name: Checkout cloudflare-docs repository
        uses: actions/checkout@v4
        with:
          repository: cloudflare/cloudflare-docs
          token: ${{ steps.generate-token.outputs.token }}
          path: cloudflare-docs

      - name: Create branch in cloudflare-docs
        run: |
          cd cloudflare-docs
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b sync-docs-pr-${{ github.event.pull_request.number }}

      - name: Create prompt for OpenCode
        id: create-prompt
        env:
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          # Store PR metadata in environment variables to avoid shell escaping issues
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}"

          # Use quoted heredoc to prevent interpretation of special characters
          cat > /tmp/claude_prompt.md <<'STATIC_EOF'
          # Intelligent Documentation Sync Task

          ## Context
          STATIC_EOF

          # Append dynamic content safely using printf
          {
            echo "- **Source Repository:** ${{ github.repository }}"
            echo "- **Original PR Number:** ${PR_NUMBER}"
            echo "- **Original PR Title:** ${PR_TITLE}"
            echo "- **Original PR URL:** ${PR_URL}"
            echo "- **Changed Files:** ${{ steps.changed-files.outputs.changed_files }}"
            echo "- **PR Description:**"
            printf '%s\n' "$PR_BODY"
          } >> /tmp/claude_prompt.md

          # Append the rest of the static content
          cat >> /tmp/claude_prompt.md <<'STATIC_EOF'


          ⚠️ **IMPORTANT**: All PR metadata above is the ONLY source of truth. Use these values EXACTLY as written.
          DO NOT fetch PR title/URL from GitHub APIs.

          ## Your Task: Evaluate and Act

          **First, gather the information you need:**
          1. Review the list of changed files above
          2. Use `gh pr diff PR_NUMBER_HERE` (replace with actual number from Context) to see the full diff for this PR
          3. Use the Read tool to examine specific files if needed

          You have access to two repositories:
          1. The current directory (our main repo)
          2. ./cloudflare-docs (already cloned with branch sync-docs-pr-PR_NUMBER_HERE checked out)

          **Step 1: Evaluate if Documentation Sync is Needed**

          Review the changes and determine if they require documentation updates in cloudflare-docs:

          - **ALWAYS sync if ANY of these are true:**
            - Documentation files in docs/ were directly changed (even if other non-doc files also changed)
            - New public API features or functions were added
            - Breaking changes that affect user-facing behavior
            - New configuration options or environment variables
            - New examples or usage patterns that should be documented
            - Bug fixes that clarify documented behavior

          - **DO NOT sync ONLY if ALL changes are:**
            - Only internal code refactoring with no behavior changes
            - Test-only changes
            - CI/workflow changes (UNLESS docs/ files also changed)
            - Minor typo fixes in code comments
            - Internal dependency updates with no API changes

          **IMPORTANT**: If this PR includes ANY changes to files in the docs/ directory, you MUST proceed with the sync, even if the PR also includes other types of changes like workflow updates.

          **Step 2: If Documentation Sync is Needed**

          If you determine documentation updates are required, YOU MUST COMPLETE ALL STEPS:

          1. Navigate to ./cloudflare-docs (already cloned, branch checked out)
          2. Adapt changes for cloudflare-docs repository structure and style
          3. Create or update the appropriate markdown files
          4. Ensure content follows cloudflare-docs conventions

          5. **CRITICAL - Commit changes:**
             Run: cd cloudflare-docs && git add . && git commit -m "Sync docs from cloudflare/sandbox-sdk#PR_NUMBER: PR_TITLE"
             (Replace PR_NUMBER and PR_TITLE with actual values from Context section)

          6. **CRITICAL - Push to remote:**
             Run: cd cloudflare-docs && git push origin sync-docs-pr-PR_NUMBER
             (Replace PR_NUMBER with actual value from Context section)

          7. **CRITICAL - Create or update PR in cloudflare-docs:**
             Use the exact PR_NUMBER, PR_TITLE, and PR_URL values from the Context section above.

             Check if PR exists: gh pr list --repo cloudflare/cloudflare-docs --head sync-docs-pr-PR_NUMBER --json number --jq '.[0].number'

             If PR exists, update it:
             gh pr edit EXISTING_PR_NUMBER --repo cloudflare/cloudflare-docs --title "Sync docs from cloudflare/sandbox-sdk#PR_NUMBER: PR_TITLE" --body "Syncs documentation changes from cloudflare/sandbox-sdk#PR_NUMBER (PR_URL): PR_TITLE"

             If PR does not exist, create it:
             gh pr create --repo cloudflare/cloudflare-docs --base main --head sync-docs-pr-PR_NUMBER --title "Sync docs from cloudflare/sandbox-sdk#PR_NUMBER: PR_TITLE" --body "Syncs documentation changes from cloudflare/sandbox-sdk#PR_NUMBER (PR_URL): PR_TITLE"

          THE TASK IS NOT COMPLETE UNTIL ALL 7 STEPS ARE DONE. Do not stop after editing files.

          ## Documentation Writing Guidelines (Diataxis Framework)

          When writing the documentation content, adapt your approach based on what changed:

          **For a single function/method:**
          - **Reference**: Technical description - signature, parameters, return types, behavior
          - **Example**: Concise code snippet showing usage in context
          - **Use cases**: Brief bullets on when/why to use it (if not obvious)
          - **DO NOT** create separate "how-to" sections - integrate examples into the reference

          **For new features/workflows (multiple related functions):**
          - **Reference**: Complete API docs for all functions
          - **How-to guide**: Step-by-step guide for real-world tasks
          - **Explanation**: Architecture, design decisions, alternatives

          **For breaking changes:**
          - **Reference**: Updated API documentation
          - **How-to**: Migration guide (before/after)
          - **Explanation**: Why changed, implications

          **Key principles:**
          - Single functions = reference + example (concise)
          - Multi-step workflows = separate how-to guides
          - Keep reference neutral and factual
          - Do not overexplain simple functions

          ## Cloudflare Docs Style Requirements

          **CRITICAL**: Follow all rules from the Cloudflare Style Guide (https://developers.cloudflare.com/style-guide/) and these specific requirements:

          **Grammar & Formatting:**
          - Do not use contractions, exclamation marks, or non-standard quotes
          - Fix common spelling errors, specifically misspellings of "wrangler"
          - Remove whitespace characters from the end of lines
          - Remove duplicate words
          - Do not use HTML for ordered lists

          **Links:**
          - Use full relative links (/sandbox-sdk/configuration/) instead of full URLs, local dev links, or dot notation
          - Always use trailing slashes for links without anchors
          - Use meaningful link words (page titles) - avoid "here", "this page", "read more"
          - Add cross-links to relevant documentation pages where appropriate

          **Components (MUST USE):**
          - All components need to be imported below frontmatter: import { ComponentName } from "~/components";
          - **WranglerConfig component**: Replace toml or json code blocks showing Wrangler configuration with the WranglerConfig component. This is CRITICAL - always use this component for wrangler.toml/wrangler.jsonc examples.
          - **DashButton component**: Replace https://dash.cloudflare.com in steps with the DashButton component
          - **APIRequest component**: Replace sh code blocks with API requests to https://api.cloudflare.com with the APIRequest component
          - **FileTree component**: Replace txt blocks showing file trees with the FileTree component
          - **PackageManagers component**: Replace sh blocks with npm commands using the PackageManagers component
          - **TypeScriptExample component**: Replace ts/typescript code blocks with the TypeScriptExample component (except in step-by-step TypeScript-specific tutorials)

          **JSX & Partials:**
          - When using JSX fragments for conditional rendering, use props variable to account for reusability
          - Only use Markdown component in JSX conditionals, and only if needed
          - Do not duplicate content in ternary/binary conditions
          - For variables in links, use HTML instead of Markdown

          **Step 3: Provide Clear Output**

          Clearly state your decision:
          - If syncing: Explain what documentation changes you are making and why
          - If not syncing: Explain why documentation updates are not needed for this PR

          ## Important Notes
          - Use the GH_TOKEN environment variable for authentication with gh CLI
          - Adapt paths, links, and references as needed for cloudflare-docs structure
          - Follow existing patterns in the cloudflare-docs repository
          - **DEFAULT TO SYNCING**: When in doubt about whether changes warrant a sync, ALWAYS create the sync PR for human review. It is better to create an unnecessary PR than to miss important documentation updates.

          Begin your evaluation now.
          STATIC_EOF

          echo "prompt<<PROMPT_EOF" >> $GITHUB_OUTPUT
          cat /tmp/claude_prompt.md >> $GITHUB_OUTPUT
          echo "PROMPT_EOF" >> $GITHUB_OUTPUT

      - name: Install OpenCode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: Run OpenCode to create adapted PR
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          opencode run -m anthropic/claude-sonnet-4-20250514 < /tmp/claude_prompt.md
