# Build ID Problem Statement for Wrangler Investigation

## Overview
When attempting to run container tests using `@cloudflare/vitest-pool-workers` with a `wrangler.toml` that has containers defined, we encounter a specific assertion error that prevents testing of container-enabled Durable Objects.

## Error Details
**Error Message:** `Build ID should be set if containers are defined and enabled`

**Error Location:** `workers-sdk/packages/wrangler/src/dev/miniflare.ts:1420`

**Full Stack Trace:**
```
AssertionError: Build ID should be set if containers are defined and enabled
 ❯ getImageNameFromDOClassName ../../node_modules/wrangler/wrangler-dist/cli.js:59148:35
 ❯ ../../node_modules/wrangler/wrangler-dist/cli.js:58899:24
 ❯ buildMiniflareBindingOptions ../../node_modules/wrangler/wrangler-dist/cli.js:58893:26
 ❯ Module.unstable_getMiniflareWorkerOptions ../../node_modules/wrangler/wrangler-dist/cli.js:183764:47
 ❯ parseCustomPoolOptions ../../node_modules/@cloudflare/vitest-pool-workers/dist/pool/index.mjs:381:71
 ❯ parseProjectOptions ../../node_modules/@cloudflare/vitest-pool-workers/dist/pool/index.mjs:452:12
 ❯ executeMethod ../../node_modules/@cloudflare/vitest-pool-workers/dist/pool/index.mjs:1735:18
 ❯ Object.runTests ../../node_modules/@cloudflare/vitest-pool-workers/dist/pool/index.mjs:1850:7
```

## Current Configuration

**wrangler.toml:**
```toml
name = "sandbox-test"
main = "src/index.ts"
compatibility_date = "2025-05-06"
compatibility_flags = ["nodejs_compat"]

[[containers]]
class_name = "Sandbox"
image = "registry.cloudflare.com/8acffcc765d5baa91c873d1459ba1a19/sandbox:76671644"
name = "sandbox"
max_instances = 1

[[durable_objects.bindings]]
class_name = "Sandbox"
name = "Sandbox"
```

**vitest.container.config.ts:**
```typescript
import { defineWorkersConfig } from '@cloudflare/vitest-pool-workers/config';

export default defineWorkersConfig({
  test: {
    globals: true,
    include: ['src/__tests__/container/**/*.test.ts'],
    
    poolOptions: {
      workers: {
        main: './src/index.ts',
        
        // This configuration triggers the error:
        wrangler: {
          configPath: './wrangler.toml',
        },
        
        miniflare: {
          bindings: {
            NODE_ENV: 'test'
          }
        },
      },
    },
    
    testTimeout: 60000,
    maxConcurrency: 1,
    isolatedStorage: true,
  },
});
```

## Environment Details
- **Package versions:**
  - `@cloudflare/vitest-pool-workers`: `^0.8.57`
  - `wrangler`: `^4.26.0`
  - `vitest`: `^3.2.4`
  - `@cloudflare/containers`: `^0.0.25`

## Actions Already Taken
1. **Container Build Success**: `npx wrangler containers build . -t cloudflare/sandbox-test:latest` completes successfully
2. **Container Deployment Works**: Direct `wrangler dev` and `wrangler deploy` work correctly with containers
3. **Container Registry Access**: Can list containers with `npx wrangler containers list` showing build IDs like `76671644`
4. **Configuration Attempts**:
   - Tried adding `build_id = "76671644"` to `[[containers]]` section → "Unexpected fields" warning
   - Tried using full registry URL with build ID in `image` field → Same error persists
   - Confirmed issue only occurs when using `vitest-pool-workers` with `wrangler.configPath`

## Investigation Requested

### Primary Questions:
1. **What is the "Build ID"** that should be set when containers are defined in the context of `src/dev/miniflare.ts:1420`?

2. **Where should this Build ID come from?** Should it be:
   - Extracted from the container registry URL?
   - Read from a specific file generated by `wrangler containers build`?
   - Set via an environment variable?
   - Configured differently in the vitest integration?

3. **What's the intended flow** for using containers with `@cloudflare/vitest-pool-workers`?

### Code Analysis Required:
Please examine `workers-sdk/packages/wrangler/src/dev/miniflare.ts` around line 1420 to understand:

1. **Assertion Logic**: What condition triggers this assertion error? What's the expected state when containers are defined?

2. **Build ID Source**: Where should the build ID be populated from? What's the relationship between:
   - Container build process (`wrangler containers build`)
   - Container registry references
   - Vitest pool workers integration
   - The build ID validation

3. **Integration Path**: How should `@cloudflare/vitest-pool-workers` properly handle container-enabled configurations?

### Expected Resolution:
One of the following outcomes:
- **Configuration Fix**: Clear instructions on how to properly configure build IDs for container testing
- **Bug Identification**: If this is a bug in the vitest integration that needs fixing
- **Feature Gap**: If container testing with vitest-pool-workers is not yet fully supported
- **Workaround Documentation**: If there's an alternative approach for testing container-enabled Durable Objects

## Impact
This issue prevents proper testing of container-enabled Durable Objects using the official Cloudflare testing framework, which is critical for validating production code paths that involve container functionality.

## Additional Context
- The error occurs specifically when `vitest-pool-workers` tries to use a wrangler config with containers
- Regular wrangler commands (dev, deploy, containers build) work correctly
- The same configuration works fine when containers section is removed from wrangler.toml
- Container instances are successfully running in production with the same configuration

This investigation will help determine whether this is a configuration issue, a bug that needs fixing, or a feature gap in the current testing infrastructure.

---

# INVESTIGATION FINDINGS & RESOLUTION

## Root Cause Analysis ✅ COMPLETED

After deep analysis of the `workers-sdk` codebase, the issue has been **definitively identified as a bug in the vitest integration**.

### Core Problem

The `@cloudflare/vitest-pool-workers` package is missing critical logic to handle container build IDs when containers are present in the wrangler configuration.

### Technical Details

1. **The Assertion** (`miniflare.ts:1420`):
   ```typescript
   assert(
     options.containerBuildId,
     "Build ID should be set if containers are defined and enabled"
   );
   ```
   This assertion requires a `containerBuildId` to be present when containers are defined.

2. **Missing Parameter** (`vitest-pool-workers/src/pool/config.ts:275`):
   ```typescript
   const { workerOptions, externalWorkers, define, main } =
     wrangler.unstable_getMiniflareWorkerOptions(
       configPath,
       options.wrangler.environment,
       {
         // ... other options
         // ❌ MISSING: containerBuildId parameter
       }
     );
   ```

3. **How Build IDs Work**:
   - Build IDs are **NOT stored in wrangler.toml**
   - They are **generated dynamically** during development using `generateContainerBuildId()`
   - Function returns an 8-character UUID slice: `randomUUID().slice(0, 8)`
   - Regular `wrangler dev` generates this automatically (`wrangler/src/dev.ts:577`)

### Key Files Analyzed

- `packages/wrangler/src/dev/miniflare.ts:1420` - Assertion location
- `packages/containers-shared/src/utils.ts:243` - Build ID generation
- `packages/vitest-pool-workers/src/pool/config.ts:275` - Missing integration
- `packages/wrangler/src/api/integrations/platform/index.ts:333` - API interface
- `packages/wrangler/src/config/environment.ts:46` - Container schema

## Resolution Status: **BUG CONFIRMED**

This is **definitively a bug** in the `@cloudflare/vitest-pool-workers` package, not a configuration issue.

## Required Fix

The vitest integration needs to be updated to generate container build IDs when containers are present:

### Patch Location
File: `packages/vitest-pool-workers/src/pool/config.ts` (around line 275)

### Code Fix Required
```typescript
// Add import
import { generateContainerBuildId } from "@cloudflare/containers-shared";

// Update the unstable_getMiniflareWorkerOptions call
const { workerOptions, externalWorkers, define, main } =
  wrangler.unstable_getMiniflareWorkerOptions(
    configPath,
    options.wrangler.environment,
    {
      imagesLocalMode: true,
      overrides: { assets: options.miniflare.assets },
      remoteBindingsEnabled: options.experimental_remoteBindings,
      remoteProxyConnectionString:
        remoteProxySessionData?.session?.remoteProxyConnectionString,
      // ✅ ADD THIS LINE:
      containerBuildId: config.containers?.length ? generateContainerBuildId() : undefined,
    }
  );
```

## Immediate Workarounds

Until the fix is implemented, you can:

1. **Remove containers from wrangler.toml temporarily** for testing
2. **Use unit tests instead of container integration tests**
3. **Mock container behavior** in your tests
4. **Test container functionality separately** using `wrangler dev`

## Impact Assessment

- **Severity**: High - Blocks container testing entirely
- **Scope**: Affects all users trying to test container-enabled Durable Objects
- **Timeline**: Bug exists in current released versions of `@cloudflare/vitest-pool-workers`

## Next Steps

1. **Report this bug** to the Cloudflare Workers SDK team
2. **Reference this analysis** when reporting
3. **Consider contributing the fix** as a pull request to workers-sdk
4. **Use workarounds** for immediate testing needs

This is a straightforward fix that should be implemented in the next version of the vitest pool workers package.